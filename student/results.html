<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êé°ÁÇπÁµêÊûú - ÂÄãÂà•ÊúÄÈÅ©ÂåñÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="common/student-style.css">
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <a href="dashboard.html" class="text-xl font-bold text-gray-800">ÂÄãÂà•ÊúÄÈÅ©ÂåñÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Â≠¶Áîü</span>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-circle text-gray-600"></i>
                            <span id="username" class="text-gray-800 font-medium"></span>
                        </div>
                        <button onclick="logout()" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ÁµêÊûú„Å™„ÅóÁîªÈù¢ -->
        <div id="no-results-screen" class="hidden min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
                <i class="fas fa-clipboard-list text-gray-400 text-5xl mb-4"></i>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Êé°ÁÇπÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h2>
                <p class="text-gray-600 mb-6">
                    „Åæ„Å†ÂïèÈ°å„ÇíËß£Á≠î„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÅÊé°ÁÇπ„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br />
                    ÂïèÈ°å„ÇíËß£Á≠î„Åó„Å¶„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ
                </p>
                <a href="problems.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    ÂïèÈ°å„ÇíËß£„Åè
                </a>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ÁµêÊûúÁîªÈù¢ -->
        <main id="main-screen" class="hidden max-w-4xl mx-auto px-4 py-8">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Êé°ÁÇπÁµêÊûú</h1>
                        <div class="flex items-center space-x-4 mt-2 text-gray-600">
                            <div class="flex items-center space-x-1">
                                <i class="fas fa-book-open"></i>
                                <span>Á¨¨7Âõû: „Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„ÇπÂü∫Á§é</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="submission-date"></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-blue-600" id="overall-score">-</div>
                        <div class="text-sm text-gray-600">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>
                    </div>
                </div>
            </div>

            <!-- Áµ±Ë®à„Çµ„Éû„É™„Éº -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Ê≠£Á≠îÂïèÈ°å</p>
                            <p class="text-2xl font-bold text-green-600" id="correct-count">-</p>
                        </div>
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">‰∏çÊ≠£Á≠îÂïèÈ°å</p>
                            <p class="text-2xl font-bold text-red-600" id="incorrect-count">-</p>
                        </div>
                        <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ÈÉ®ÂàÜÁÇπÂïèÈ°å</p>
                            <p class="text-2xl font-bold text-yellow-600" id="partial-count">-</p>
                        </div>
                        <i class="fas fa-star-half-alt text-yellow-600 text-2xl"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Ëß£Á≠îÊôÇÈñì</p>
                            <p class="text-2xl font-bold text-purple-600" id="total-time">-</p>
                        </div>
                        <i class="fas fa-clock text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- ÂÄãÂà•ÂïèÈ°åÁµêÊûú -->
            <div class="space-y-6" id="problem-results">
                <!-- ÂÄãÂà•ÁµêÊûú„ÅØJavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>

            <!-- ÁêÜËß£Â∫¶Âêë‰∏ä„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl shadow-lg p-6 mt-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    ÁêÜËß£Â∫¶Âêë‰∏ä„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ
                </h2>
                <div id="advice-content" class="space-y-3 text-gray-700">
                    <!-- „Ç¢„Éâ„Éê„Ç§„Çπ„ÅØJavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>

            <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
            <div class="flex justify-center space-x-4 mt-8">
                <a href="dashboard.html" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-home mr-2"></i>
                    „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã
                </a>
                <a href="problems.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-redo mr-2"></i>
                    ÂÜçÊåëÊà¶„Åô„Çã
                </a>
            </div>
        </main>
    </div>

    <script src="../common/data.js"></script>
    <script src="common/student-nav.js"></script>
    <script>
        let problemResults = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadStudentData();
            loadResults();
        });

        function loadStudentData() {
            const student = LocalStorage.getCurrentUser();
            document.getElementById('username').textContent = student.name;
        }

        function loadResults() {
            problemResults = LocalStorage.getProblemResults();
            
            if (Object.keys(problemResults).length === 0) {
                document.getElementById('no-results-screen').classList.remove('hidden');
                return;
            }
            
            document.getElementById('main-screen').classList.remove('hidden');
            
            // Ê®°Êì¨Êé°ÁÇπÁµêÊûú„ÇíÁîüÊàêÔºàÂÆüÈöõ„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØAIÊé°ÁÇπÁµêÊûú„Çí‰ΩøÁî®Ôºâ
            generateMockScores();
            displayResults();
            generateAdvice();
        }

        function generateMockScores() {
            // „Éá„É¢Áî®„ÅÆÊé°ÁÇπÁµêÊûúÁîüÊàê
            const scores = [85, 92, 78, 88, 90]; // ÂêÑÂïèÈ°å„ÅÆ„Çπ„Ç≥„Ç¢
            const comments = [
                "2√ó2ÂàÜÂâ≤Ë°®„ÅÆË®àÁÆó„ÅØÊ≠£Á¢∫„Åß„Åó„Åü„ÄÇË®àÁÆóÈÅéÁ®ã„ÇÇÊòéÁ¢∫„Å´Á§∫„Åï„Çå„Å¶„Åä„Çä„ÄÅÁêÜËß£Â∫¶„ÅåÈ´ò„ÅÑ„Åì„Å®„Åå„Çè„Åã„Çä„Åæ„Åô„ÄÇ",
                "„É™„Çπ„ÇØÊØî„ÅÆÂÆöÁæ©„ÇíÊ≠£„Åó„ÅèÈÅ∏Êäû„Åß„Åç„Åæ„Åó„Åü„ÄÇÁñ´Â≠¶„ÅÆÂü∫Êú¨Ê¶ÇÂøµ„Çí„Çà„ÅèÁêÜËß£„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
                "Ê∑∑ÂêåË°åÂàó„ÅÆÁî®Ë™û„Å´„Å§„ÅÑ„Å¶‰∏ÄÈÉ®‰∏çÊ≠£Á¢∫„Å™ÈÉ®ÂàÜ„Åå„ÅÇ„Çä„Åæ„Åó„Åü„Åå„ÄÅÂü∫Êú¨ÁöÑ„Å™ÁêÜËß£„ÅØ„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
                "ÂõûÂ∏∞ÂàÜÊûê„ÅÆË®àÁÆó„ÅØÊ¶Ç„Å≠Ê≠£Á¢∫„Åß„Åó„Åü„ÄÇÊúÄÂ∞è‰∫å‰πóÊ≥ï„ÅÆÁêÜËß£„ÅåÊ∑±„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
                "Ê±∫ÂÆö‰øÇÊï∞„ÅÆËß£Èáà„ÅØÂÆåÁíß„Åß„Åó„Åü„ÄÇÁµ±Ë®àÁöÑÊ¶ÇÂøµ„ÅÆÁêÜËß£„ÅåÂÑ™ÁßÄ„Åß„Åô„ÄÇ"
            ];
            
            Object.keys(problemResults).forEach((problemId, index) => {
                problemResults[problemId].score = scores[index] || 80;
                problemResults[problemId].max_score = 100;
                problemResults[problemId].feedback = comments[index] || "ËâØ„ÅÑËß£Á≠î„Åß„Åó„Åü„ÄÇ";
                problemResults[problemId].correct_answer = generateCorrectAnswer(parseInt(problemId));
            });
        }

        function generateCorrectAnswer(problemId) {
            const correctAnswers = {
                1: "ÊÑüÂ∫¶ = 85/95 = 0.895 (89.5%)\nÁâπÁï∞Â∫¶ = 90/105 = 0.857 (85.7%)\nÁ≤æÂ∫¶ = (85+90)/200 = 0.875 (87.5%)",
                2: "Êö¥Èú≤Áæ§„ÅÆ„É™„Çπ„ÇØ √∑ ÈùûÊö¥Èú≤Áæ§„ÅÆ„É™„Çπ„ÇØ",
                3: "1:ÁúüÈôΩÊÄß„ÄÅ2:ÁúüÈô∞ÊÄß„ÄÅ3:ÂÅΩÈô∞ÊÄß„ÄÅ4:ÂÅΩÈôΩÊÄß",
                4: "ÂõûÂ∏∞‰øÇÊï∞a = 1.97„ÄÅÂàáÁâáb = 0.14\ny = 1.97x + 0.14",
                5: "ÂÖ®‰Ωì„ÅÆÂ§âÂãï„ÅÆ75%„ÅåÂõûÂ∏∞„É¢„Éá„É´„ÅßË™¨Êòé„Åß„Åç„Çã"
            };
            return correctAnswers[problemId] || "Ëß£Á≠î‰æã„ÅØ„Ç∑„Çπ„ÉÜ„É†„ÅßÁÆ°ÁêÜ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ";
        }

        function displayResults() {
            const resultsArray = Object.values(problemResults);
            
            // ÊèêÂá∫Êó•ÊôÇ
            const latestSubmission = Math.max(...resultsArray.map(r => new Date(r.submitted_at).getTime()));
            document.getElementById('submission-date').textContent = 
                new Date(latestSubmission).toLocaleDateString('ja-JP');
            
            // Áµ±Ë®àË®àÁÆó
            const totalScore = resultsArray.reduce((sum, r) => sum + r.score, 0);
            const avgScore = Math.round(totalScore / resultsArray.length);
            const correctCount = resultsArray.filter(r => r.score >= 90).length;
            const incorrectCount = resultsArray.filter(r => r.score < 60).length;
            const partialCount = resultsArray.filter(r => r.score >= 60 && r.score < 90).length;
            const totalTime = resultsArray.reduce((sum, r) => sum + (r.time_spent || 0), 0);
            
            document.getElementById('overall-score').textContent = avgScore + 'ÁÇπ';
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = incorrectCount;
            document.getElementById('partial-count').textContent = partialCount;
            document.getElementById('total-time').textContent = formatTime(totalTime);
            
            // ÂÄãÂà•ÂïèÈ°åÁµêÊûú„ÇíË°®Á§∫
            const container = document.getElementById('problem-results');
            resultsArray.forEach((result, index) => {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'bg-white rounded-xl shadow-lg p-6';
                
                const scoreColor = getScoreColor(result.score);
                const scoreIcon = getScoreIcon(result.score);
                
                problemDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${result.problem.title}</h3>
                            <div class="flex items-center space-x-3 mt-2">
                                <span class="px-2 py-1 rounded text-xs ${getTypeColor(result.problem.type)}">
                                    ${getTypeLabel(result.problem.type)}
                                </span>
                                <span class="text-sm text-gray-600">
                                    Èõ£ÊòìÂ∫¶: ${result.problem.difficulty}
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <i class="${scoreIcon} ${scoreColor}"></i>
                                <span class="text-2xl font-bold ${scoreColor}">
                                    ${result.score}ÁÇπ
                                </span>
                            </div>
                            <div class="text-sm text-gray-500">/ ${result.max_score}ÁÇπ</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">„ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î</h4>
                            <div class="bg-gray-50 rounded-lg p-3 text-sm text-gray-700 max-h-32 overflow-y-auto">
                                ${formatAnswer(result.answer)}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Ê≠£Ëß£„ÉªËß£Ë™¨</h4>
                            <div class="bg-blue-50 rounded-lg p-3 text-sm text-gray-700 max-h-32 overflow-y-auto">
                                ${result.correct_answer}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-1">„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h4>
                        <p class="text-sm text-gray-700">${result.feedback}</p>
                    </div>
                `;
                
                container.appendChild(problemDiv);
            });
        }

        function generateAdvice() {
            const resultsArray = Object.values(problemResults);
            const avgScore = resultsArray.reduce((sum, r) => sum + r.score, 0) / resultsArray.length;
            const weakAreas = resultsArray.filter(r => r.score < 80);
            
            const container = document.getElementById('advice-content');
            
            let advice = [];
            
            if (avgScore >= 90) {
                advice.push("üéâ Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÁ∏æ„Åß„ÅôÔºÅ„Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„Çπ„ÅÆÂü∫Á§éÊ¶ÇÂøµ„Çí„Çà„ÅèÁêÜËß£„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
                advice.push("üìö „Çà„ÇäÈ´òÂ∫¶„Å™Áµ±Ë®àÊâãÊ≥ï„ÇÑÊ©üÊ¢∞Â≠¶Áøí„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆÂ≠¶Áøí„Å´ÊåëÊà¶„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ");
            } else if (avgScore >= 75) {
                advice.push("üëç ËâØ„ÅÑÊàêÁ∏æ„Åß„ÅôÔºÅÂü∫Êú¨ÁöÑ„Å™Ê¶ÇÂøµ„ÅØÁêÜËß£„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
                advice.push("üîç ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÇíÂæ©Áøí„Åó„ÄÅÁêÜËß£„ÇíÊ∑±„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ");
            } else {
                advice.push("üìñ Âü∫Á§éÊ¶ÇÂøµ„ÅÆÂæ©Áøí„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ");
                advice.push("ü§ù ÂàÜ„Åã„Çâ„Å™„ÅÑÈÉ®ÂàÜ„ÅØÈÅ†ÊÖÆ„Å™„ÅèË≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
            
            if (weakAreas.length > 0) {
                const weakKeywords = [...new Set(weakAreas.flatMap(r => r.problem.keywords))];
                advice.push(`üéØ Áâπ„Å´„Äå${weakKeywords.join('„Äç„ÄÅ„Äå')}„Äç„ÅÆÁêÜËß£Â∫¶Âêë‰∏ä„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`);
            }
            
            advice.push("üîÑ ÁêÜËß£Â∫¶„ÇíÊ∑±„ÇÅ„Çã„Åü„ÇÅ„ÄÅÈ°û‰ººÂïèÈ°å„Å´ÂÜçÊåëÊà¶„Åô„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ");
            
            container.innerHTML = advice.map(a => `<p>${a}</p>`).join('');
        }

        function getScoreColor(score) {
            if (score >= 90) return 'text-green-600';
            if (score >= 75) return 'text-blue-600';
            if (score >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }

        function getScoreIcon(score) {
            if (score >= 90) return 'fas fa-check-circle';
            if (score >= 75) return 'fas fa-thumbs-up';
            if (score >= 60) return 'fas fa-star-half-alt';
            return 'fas fa-times-circle';
        }

        function getTypeColor(type) {
            switch (type) {
                case 'calculation': return 'bg-purple-100 text-purple-800';
                case 'choice': return 'bg-green-100 text-green-800';
                case 'fill': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeLabel(type) {
            switch (type) {
                case 'calculation': return 'Ë®àÁÆóÂïèÈ°å';
                case 'choice': return 'ÈÅ∏ÊäûÂïèÈ°å';
                case 'fill': return 'Á©¥Âüã„ÇÅÂïèÈ°å';
                default: return type;
            }
        }

        function formatAnswer(answer) {
            if (typeof answer === 'string') {
                try {
                    const parsed = JSON.parse(answer);
                    if (typeof parsed === 'object') {
                        return Object.entries(parsed).map(([key, value]) => `${key}: ${value}`).join(', ');
                    }
                    return answer;
                } catch {
                    return answer;
                }
            }
            return String(answer);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                window.location.href = '../common/auth.html';
            }
        }
    </script>
</body>
</html>